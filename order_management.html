<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理系统 - SHIAWASE (S) PTE LTD</title>
    <link rel="stylesheet" href="product.css">
    <!-- Vue 3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-font-asian@0.0.3/dist/SimSun-normal.js"></script>
    <style>
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1000px;
            border-radius: 8px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #1a3c6e;
            padding-bottom: 12px;
        }

        .modal-header h2 {
            font-size: 1.6rem;
            margin: 0;
        }

        .details-section {
            margin-bottom: 25px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .details-section h3 {
            color: #1a3c6e;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .details-row {
            display: flex;
            margin: 10px 0;
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 1rem;
        }

        .details-label {
            font-weight: 600;
            color: #555;
            min-width: 160px;
        }

        .details-value {
            color: #333;
            flex: 1;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 1rem;
        }

        .items-table th,
        .items-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .items-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #1a3c6e;
        }

        .modal-actions {
            margin-top: 25px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            padding: 12px 20px;
            font-size: 1rem;
            min-height: 45px;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 15px;
            }
            
            .details-row {
                flex-direction: column;
                gap: 4px;
            }
            
            .details-label {
                min-width: auto;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
                min-height: 45px;
            }
        }
    </style>
</head>
<body>
    <!-- Initial loading screen -->
    <div id="initial-loading" class="app-loading">
        <div class="app-loading-spinner"></div>
        <div class="app-loading-text">Loading...</div>
    </div>

    <div id="app">
        <header>
            <div class="header-content">
                <div class="logo">
                    <img src="logo.png" alt="Logo"> SHIAWASE (S) PTE LTD
                </div>
                <div class="header-actions">
                    <div v-if="isAuthenticated" class="user-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                        {{ userEmail }}
                    </div>
                    <button class="back-btn" @click="goBack">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                        </svg>
                        {{ t('back') || 'Back' }}
                    </button>
                    <button class="language-toggle" @click="toggleLanguage">
                        {{ currentLang === 'zh' ? 'English' : '中文' }}
                    </button>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- Auth loading state -->
            <div v-if="isCheckingAuth" class="auth-loading">
                <div class="loading-spinner"></div>
                <p>{{ t('checkingAuth') || 'Checking authentication...' }}</p>
            </div>
            
            <!-- Content is visible only when authenticated -->
            <div v-else-if="isAuthenticated">
                <h1>{{ t('appTitle') }} <span class="english-subtext" v-if="currentLang === 'zh'">Order Management</span></h1>
                
                <!-- Message display -->
                <div v-if="message.text" :class="['message', message.type === 'success' ? 'message-success' : 'message-error']">
                    {{ message.text }}
                </div>
                
                <!-- Filters -->
                <div class="card">
                    <h2>{{ t('filters') }} <span class="english-subtext" v-if="currentLang === 'zh'">Filters</span></h2>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="search">{{ t('search') }}</label>
                            <input id="search" type="text" class="search-input" v-model="searchQuery" 
                                :placeholder="t('searchOrders')">
                        </div>
                        <div class="filter-group">
                            <label for="outletFilter">{{ t('filterByOutlet') }}</label>
                            <select id="outletFilter" class="form-control" v-model="outletFilter">
                                <option value="all">{{ t('allOutlets') }}</option>
                                <option v-for="prefix in availableOutletPrefixes" :key="prefix" :value="prefix">
                                    {{ prefix }}
                                </option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>{{ t('dateRange') }}</label>
                            <div class="date-filter-group">
                                <input type="date" v-model="startDate" class="form-control">
                                <span>-</span>
                                <input type="date" v-model="endDate" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Grid -->
                <h2>{{ t('ordersList') }} <span class="english-subtext" v-if="currentLang === 'zh'">Orders List</span></h2>
                
                <div v-if="isLoading" class="loading">{{ t('loadingOrders') }}</div>
                
                <div v-else-if="filteredOrders.length === 0" class="empty-state">
                    {{ t('noOrdersFound') }}
                </div>
                
                <div v-else class="orders-grid">
                    <div v-for="order in filteredOrders" :key="order.id" class="order-card" @click="viewOrderDetails(order)">
                        <div class="order-card-header">
                            <span class="order-id">{{ order.orderId }}</span>
                            <span :class="['order-status', getStatusClass(order?.status)]">
                                {{ getStatusText(order?.status) }}
                            </span>
                        </div>
                        <div class="order-card-body">
                            <div class="order-card-row">
                                <span>{{ t('outlet') }}:</span>
                                <span class="outlet-name">{{ order.outletName }}</span>
                            </div>
                            <div class="order-card-row">
                                <span>{{ t('date') }}:</span>
                                <span>{{ formatDate(order.createdAt) }}</span>
                            </div>
                            <div class="order-card-row">
                                <span>{{ t('total') }}:</span>
                                <span>${{ order.grandTotal?.toFixed(2) || '0.00' }}</span>
                            </div>
                            <div class="order-card-row">
                                <span>{{ t('items') }}:</span>
                                <span>{{ order.itemsCount || 0 }}</span>
                            </div>
                            <div v-if="order?.status?.toLowerCase() === 'pending' || order?.status?.toLowerCase() === 'processing'" class="order-card-row" style="margin-top: 10px;">
                                <button v-if="order?.status?.toLowerCase() === 'pending'" class="btn btn-primary btn-sm" @click.stop="updateOrderStatus(order, 'processing')" :disabled="updatingStatus" style="width: 48%;">
                                    {{ updatingStatus ? t('updating') : t('markAsProcessing') }}
                                </button>
                                <button class="btn btn-danger btn-sm" @click.stop="updateOrderStatus(order, 'cancelled')" :disabled="updatingStatus" style="width: 48%;">
                                    {{ updatingStatus ? t('updating') : t('cancelOrder') }}
                                </button>
                            </div>
                            <div v-if="order?.status?.toLowerCase() === 'cancelled'" class="order-card-row" style="margin-top: 10px;">
                                <button class="btn btn-primary btn-sm" @click.stop="updateOrderStatus(order, 'pending')" :disabled="updatingStatus" style="width: 100%;">
                                    {{ updatingStatus ? t('updating') : t('undoCancellation') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Details Modal -->
                <div id="orderModal" class="modal" :style="{display: showModal ? 'block' : 'none'}">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>{{ t('orderDetails') }} - {{ selectedOrder?.orderId }}</h2>
                            <span class="close" @click="closeModal">&times;</span>
                        </div>
                        
                        <div v-if="selectedOrder" class="order-details">
                            <!-- Order Information -->
                            <div class="details-section">
                                <h3>{{ t('orderInformation') }}</h3>
                                <div class="details-row">
                                    <span class="details-label">{{ t('orderId') }}:</span>
                                    <span class="details-value">{{ selectedOrder.orderId }}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">{{ t('orderDate') }}:</span>
                                    <span class="details-value">{{ formatDateTime(selectedOrder.createdAt) }}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">{{ t('deliveryDate') }}:</span>
                                    <span class="details-value">{{ selectedOrder.deliveryDate || '-' }}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">{{ t('status') }}:</span>
                                    <span class="details-value">{{ getStatusText(selectedOrder?.status) }}</span>
                                </div>
                                <div class="details-row" v-if="selectedOrder.referenceNumber">
                                    <span class="details-label">{{ t('referenceNumber') }}:</span>
                                    <span class="details-value">{{ selectedOrder.referenceNumber }}</span>
                                </div>
                            </div>
                            
                            <!-- Outlet Information -->
                            <div class="details-section">
                                <h3>{{ t('outletInformation') }}</h3>
                                <div class="details-row">
                                    <span class="details-label">{{ t('outletCode') }}:</span>
                                    <span class="details-value">{{ selectedOrder.outletId }}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">{{ t('outletName') }}:</span>
                                    <span class="details-value">{{ selectedOrder.outletName }}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">{{ t('outletAddress') }}:</span>
                                    <span class="details-value">{{ selectedOrder.outletAddress }}</span>
                                </div>
                            </div>
                            
                            <!-- Order Items -->
                            <div class="details-section">
                                <h3>{{ t('orderItems') }}</h3>
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>{{ t('serialNumber') || 'S/N' }}</th>
                                            <th>{{ t('productName') }}</th>
                                            <th>{{ t('quantity') }}</th>
                                            <th>{{ t('unit') }}</th>
                                            <th>{{ t('price') }}</th>
                                            <th>{{ t('subtotal') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(item, index) in selectedOrder.items" :key="index">
                                            <td>{{ index + 1 }}</td>
                                            <td>{{ item.name }}</td>
                                            <td>{{ item.quantity }}</td>
                                            <td>{{ item.unit }} ({{ item.unitChinese }})</td>
                                            <td>${{ item.price?.toFixed(2) }}</td>
                                            <td>${{ item.subtotal?.toFixed(2) }}</td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="5" style="text-align: right; font-weight: bold;">
                                                {{ t('subtotal') }}:
                                            </td>
                                            <td style="font-weight: bold;">
                                                ${{ selectedOrder.subTotal?.toFixed(2) || '0.00' }}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="5" style="text-align: right; font-weight: bold;">
                                                {{ t('gst') }} (9%):
                                            </td>
                                            <td style="font-weight: bold;">
                                                ${{ ((selectedOrder.subTotal || 0) * 0.09).toFixed(2) }}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="5" style="text-align: right; font-weight: bold; font-size: 1.1em;">
                                                {{ t('grandTotal') }}:
                                            </td>
                                            <td style="font-weight: bold; font-size: 1.1em;">
                                                ${{ selectedOrder.grandTotal?.toFixed(2) || '0.00' }}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Remarks -->
                            <div class="details-section" v-if="selectedOrder.remarks">
                                <h3>{{ t('remarks') }}</h3>
                                <p>{{ selectedOrder.remarks }}</p>
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-pdf" @click="downloadPDF">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px;">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                {{ t('downloadInvoice') }}
                            </button>
                            <button v-if="selectedOrder?.status?.toLowerCase() === 'cancelled'" class="btn btn-primary" @click="updateOrderStatus(selectedOrder, 'pending')" :disabled="updatingStatus">
                                {{ updatingStatus ? t('updating') : t('undoCancellation') }}
                            </button>
                            <button v-if="selectedOrder?.status?.toLowerCase() === 'pending' || selectedOrder?.status?.toLowerCase() === 'processing'" class="btn btn-danger" @click="updateOrderStatus(selectedOrder, 'cancelled')" :disabled="updatingStatus">
                                {{ updatingStatus ? t('updating') : t('cancelOrder') }}
                            </button>
                            <button class="btn btn-secondary" @click="closeModal">{{ t('close') }}</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Not authenticated message -->
            <div v-else class="auth-error">
                <h2>{{ t('notAuthorized') || 'Not Authorized' }}</h2>
                <p>{{ t('redirectingToLogin') || 'You are not authorized to access this page. Redirecting to home...' }}</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase v9 (modular) -->
    <script type="module">
        import { firebaseConfig } from './secrets.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            updateDoc,
            orderBy, 
            query,
            where,
            Timestamp,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { 
            getAuth,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Create Vue app
        const { createApp, ref, onMounted, computed, watch } = Vue;
        createApp({
            setup() {
                // Authentication states
                const isAuthenticated = ref(false);
                const isCheckingAuth = ref(true);
                const userEmail = ref('');
                
                // Check authentication
                const checkAuthStatus = (user) => {
                    if (user) {
                        isAuthenticated.value = true;
                        userEmail.value = user.email;
                    } else {
                        isAuthenticated.value = false;
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    }
                    isCheckingAuth.value = false;
                };
                
                // Back button function
                const goBack = () => {
                    window.location.href = 'index.html';
                };
                
                // Language settings
                const currentLang = ref('zh');
                
                // Translations
                const translations = {
                    appTitle: { zh: '订单管理系统', en: 'Order Management System' },
                    back: { zh: '返回', en: 'Back' },
                    filters: { zh: '筛选器', en: 'Filters' },
                    search: { zh: '搜索', en: 'Search' },
                    searchOrders: { zh: '搜索订单...', en: 'Search orders...' },
                    filterByOutlet: { zh: '按门店筛选', en: 'Filter by Outlet' },
                    allOutlets: { zh: '所有门店', en: 'All Outlets' },
                    dateRange: { zh: '日期范围', en: 'Date Range' },
                    ordersList: { zh: '订单列表', en: 'Orders List' },
                    loadingOrders: { zh: '加载订单中...', en: 'Loading orders...' },
                    noOrdersFound: { zh: '未找到订单', en: 'No orders found' },
                    outlet: { zh: '门店', en: 'Outlet' },
                    date: { zh: '日期', en: 'Date' },
                    total: { zh: '总额', en: 'Total' },
                    items: { zh: '商品数', en: 'Items' },
                    orderDetails: { zh: '订单详情', en: 'Order Details' },
                    orderInformation: { zh: '订单信息', en: 'Order Information' },
                    orderId: { zh: '订单编号', en: 'Order ID' },
                    orderDate: { zh: '订单日期', en: 'Order Date' },
                    deliveryDate: { zh: '送货日期', en: 'Delivery Date' },
                    status: { zh: '状态', en: 'Status' },
                    referenceNumber: { zh: '参考编号', en: 'Reference Number' },
                    outletInformation: { zh: '门店信息', en: 'Outlet Information' },
                    outletCode: { zh: '门店代码', en: 'Outlet Code' },
                    outletName: { zh: '门店名称', en: 'Outlet Name' },
                    outletAddress: { zh: '门店地址', en: 'Outlet Address' },
                    orderItems: { zh: '订单商品', en: 'Order Items' },
                    serialNumber: { zh: '序号', en: 'S/N' },
                    productCode: { zh: '产品代码', en: 'Product Code' },
                    productName: { zh: '产品名称', en: 'Product Name' },
                    quantity: { zh: '数量', en: 'Quantity' },
                    unit: { zh: '单位', en: 'Unit' },
                    price: { zh: '单价', en: 'Price' },
                    subtotal: { zh: '小计', en: 'Subtotal' },
                    gst: { zh: '消费税', en: 'GST' },
                    grandTotal: { zh: '总计', en: 'Grand Total' },
                    remarks: { zh: '备注', en: 'Remarks' },
                    downloadInvoice: { zh: '下载发票', en: 'Download Invoice' },
                    close: { zh: '关闭', en: 'Close' },
                    statusDelivered: { zh: '已送达', en: 'Delivered' },
                    statusPending: { zh: '待处理', en: 'Pending' },
                    statusProcessing: { zh: '处理中', en: 'Processing' },
                    statusCancelled: { zh: '已取消', en: 'Cancelled' },
                    markAsProcessing: { zh: '标记为处理中', en: 'Process Order' },
                    updating: { zh: '更新中...', en: 'Updating...' },
                    orderStatusUpdated: { zh: '订单状态已更新', en: 'Order status has been updated' },
                    failedToUpdateStatus: { zh: '更新状态失败: {0}', en: 'Failed to update status: {0}' },
                    checkingAuth: { zh: '验证身份中...', en: 'Checking authentication...' },
                    notAuthorized: { zh: '未授权访问', en: 'Not Authorized' },
                    redirectingToLogin: { zh: '您无权访问此页面。正在重定向到首页...', en: 'You are not authorized to access this page. Redirecting to home...' },
                    cancelOrder: { zh: '取消订单', en: 'Cancel Order' },
                    undoCancellation: { zh: '撤销取消', en: 'Undo Cancellation' }
                };
                            
                // Function to get translation
                const t = (key, ...args) => {
                    let text = translations[key]?.[currentLang.value] || key;
                    if (args.length > 0) {
                        args.forEach((arg, index) => {
                            text = text.replace(`{${index}}`, arg);
                        });
                    }
                    return text;
                };
                
                // Data
                const orders = ref([]);
                const isLoading = ref(false);
                const searchQuery = ref('');
                const outletFilter = ref('all');
                const startDate = ref('');
                const endDate = ref('');
                const showModal = ref(false);
                const selectedOrder = ref(null);
                const updatingStatus = ref(false);
                const message = ref({ type: '', text: '' });
                
                // Get unique outlet prefixes
                const availableOutletPrefixes = computed(() => {
                    const prefixes = new Set();
                    orders.value.forEach(order => {
                        if (order.outletId) {
                            const prefix = order.outletId.split('-')[0];
                            if (prefix) prefixes.add(prefix);
                        }
                    });
                    return Array.from(prefixes).sort();
                });
                
                // Filter orders
                const filteredOrders = computed(() => {
                    let filtered = orders.value;
                    
                    // Search filter
                    if (searchQuery.value) {
                        const query = searchQuery.value.toLowerCase();
                        filtered = filtered.filter(order => 
                            order.orderId?.toLowerCase().includes(query) ||
                            order.outletName?.toLowerCase().includes(query) ||
                            order.outletId?.toLowerCase().includes(query)
                        );
                    }
                    
                    // Outlet prefix filter
                    if (outletFilter.value !== 'all') {
                        filtered = filtered.filter(order => 
                            order.outletId?.startsWith(outletFilter.value + '-')
                        );
                    }
                    
                    // Date range filter
                    if (startDate.value || endDate.value) {
                        filtered = filtered.filter(order => {
                            const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                            const orderDateStr = orderDate.toISOString().split('T')[0];
                            
                            if (startDate.value && endDate.value) {
                                return orderDateStr >= startDate.value && orderDateStr <= endDate.value;
                            } else if (startDate.value) {
                                return orderDateStr >= startDate.value;
                            } else if (endDate.value) {
                                return orderDateStr <= endDate.value;
                            }
                            return true;
                        });
                    }
                    
                    return filtered;
                });
                
                // Format date
                const formatDate = (timestamp) => {
                    if (!timestamp) return '-';
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                // Format date and time
                const formatDateTime = (timestamp) => {
                    if (!timestamp) return '-';
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                };
                
                // Get status class
                const getStatusClass = (status) => {
                    switch (status?.toLowerCase()) {
                        case 'delivered': return 'status-delivered';
                        case 'pending': return 'status-pending';
                        case 'processing': return 'status-processing';
                        case 'cancelled': return 'status-cancelled';
                        default: return 'status-pending';
                    }
                };
                
                // Get status text
                const getStatusText = (status) => {
                    switch (status?.toLowerCase()) {
                        case 'delivered': return t('statusDelivered');
                        case 'pending': return t('statusPending');
                        case 'processing': return t('statusProcessing');
                        case 'cancelled': return t('statusCancelled');
                        default: return status || t('statusPending');
                    }
                };
                
                // Load orders
                const loadOrders = async () => {
                    isLoading.value = true;
                    
                    try {
                        const ordersRef = collection(db, 'orders');
                        const q = query(ordersRef, orderBy('createdAt', 'desc'));
                        const snapshot = await getDocs(q);
                        
                        const loadedOrders = [];
                        
                        for (const doc of snapshot.docs) {
                            const data = doc.data();
                            
                            // Calculate items count
                            let itemsCount = 0;
                            if (data.items) {
                                itemsCount = Object.keys(data.items).length;
                            }
                            
                            loadedOrders.push({
                                id: doc.id,
                                orderId: data.id || doc.id,
                                orderNumber: data.orderNumber,
                                createdAt: data.createdAt,
                                deliveryDate: data.deliveryDate,
                                status: data.status || 'pending',
                                outletId: data.outletId,
                                outletName: data.outletName,
                                outletAddress: data.outletAddress,
                                grandTotal: data.grandTotal || 0,
                                subTotal: data.subTotal || 0,
                                gst: 0.09, // Fixed GST at 9%
                                items: data.items ? Object.values(data.items) : [],
                                itemsCount: itemsCount,
                                referenceNumber: data.referenceNumber,
                                remarks: data.remarks
                            });
                        }
                        
                        orders.value = loadedOrders;
                    } catch (error) {
                        console.error('Error loading orders:', error);
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                // View order details
                const viewOrderDetails = (order) => {
                    selectedOrder.value = order;
                    showModal.value = true;
                };
                
                // Close modal
                const closeModal = () => {
                    showModal.value = false;
                    selectedOrder.value = null;
                };
                
                // Download PDF with cutoff time logic
                const downloadPDF = async () => {
                    if (!selectedOrder.value) return;
                    
                    try {
                        const order = selectedOrder.value;
                        const orderDate = order.createdAt.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                        const orderTime = orderDate.getHours() * 60 + orderDate.getMinutes(); // Convert to minutes
                        const cutoffTime = 16 * 60 + 30; // 4:30 PM in minutes
                        
                        // Determine which date to use for invoice
                        let invoiceDate = new Date(orderDate);
                        if (orderTime > cutoffTime) {
                            // If order is after 4:30 PM, use next day
                            invoiceDate.setDate(invoiceDate.getDate() + 1);
                        }
                        
                        // Calculate the start and end for the invoice window
                        const invoiceStart = new Date(invoiceDate);
                        invoiceStart.setDate(invoiceDate.getDate() - 1);
                        invoiceStart.setHours(16, 30, 0, 0); // Previous day 16:30

                        const invoiceEnd = new Date(invoiceDate);
                        invoiceEnd.setHours(16, 30, 0, 0); // Invoice day 16:30

                        // Fetch all orders for the same outlet in the invoice window
                        const ordersRef = collection(db, 'orders');
                        const q = query(
                            ordersRef,
                            where('outletId', '==', order.outletId),
                            where('createdAt', '>', invoiceStart),
                            where('createdAt', '<=', invoiceEnd),
                            where('status', 'in', ['processing', 'delivered'])
                        );
                        
                        const snapshot = await getDocs(q);
                        const relatedOrders = [];
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            relatedOrders.push({
                                id: doc.id,
                                ...data,
                                createdAt: data.createdAt
                            });
                        });

                        // If no valid orders found, show message and return
                        if (relatedOrders.length === 0) {
                            alert('No valid orders found for this date. Only processing and delivered orders can be included in invoices.');
                            return;
                        }
                        
                        // Combine items from all orders
                        const combinedItems = {};
                        let totalSubtotal = 0;
                        
                        relatedOrders.forEach(order => {
                            if (order.items) {
                                Object.values(order.items).forEach(item => {
                                    const key = `${item.name}_${item.unit}`;
                                    if (!combinedItems[key]) {
                                        combinedItems[key] = {
                                            name: item.name,
                                            unit: item.unit,
                                            UOM: item.UOM,
                                            unitChinese: item.unitChinese,
                                            quantity: 0,
                                            price: item.price,
                                            subtotal: 0
                                        };
                                    }
                                    combinedItems[key].quantity += item.quantity;
                                    combinedItems[key].subtotal += item.subtotal;
                                    totalSubtotal += item.subtotal;
                                });
                            }
                        });
                        
                        // Generate PDF
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        let y = 20;
                        
                        // Company header
                        doc.setFontSize(18);
                        doc.text('SHIAWASE (S) PTE LTD', 105, y, { align: 'center' });
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.text('5 Mandai Link #09-06 Mandai Food Link Singapore 728654', 105, y, { align: 'center' });
                        y += 6;
                        doc.text('Tel: (65) 6570 9171', 105, y, { align: 'center' });
                        y += 6;
                        doc.text('GST REGISTRATION NO. 201015007Z', 105, y, { align: 'center' });
                        y += 10;

                        doc.setFontSize(12);
                        doc.text('TAX INVOICE', 105, y, { align: 'center' });
                        
                        // Order information
                        doc.setFontSize(10);
                        y += 10;
                        doc.text('DELIVER TO :', 20, y);
                        y += 5;
                        
                        // Address
                        const addressText = order.outletAddress || '';
                        const addressLines = doc.splitTextToSize(addressText, 90);
                        const addressStartY = y;
                        addressLines.forEach(line => {
                            doc.text(line, 20, y);
                            y += 6;
                        });
                        
                        // Prepare formatted date for invoice number
                        const formattedDate = formatDate(invoiceDate).replace(/\//g, '');
                        // Find the highest order ID from related orders (use part after dash)
                        const numericOrderIds = relatedOrders
                            .map(order => {
                                // Use order.orderId if present, otherwise order.id
                                const oid = order.orderId || order.id || '';
                                if (oid) {
                                    if (oid.includes('-')) {
                                        const parts = oid.split('-');
                                        const num = parseInt(parts[1], 10);
                                        return !isNaN(num) ? num : null;
                                    }
                                    const num = parseInt(oid, 10);
                                    return !isNaN(num) ? num : null;
                                }
                                return null;
                            })
                            .filter(num => num !== null);

                        let invoiceNumberPrefix;
                        if (numericOrderIds.length > 0) {
                            invoiceNumberPrefix = Math.max(...numericOrderIds);
                        } else if (relatedOrders.length > 0) {
                            // Use the first order's orderId or id, removing any non-numeric characters
                            const firstOrderId = relatedOrders[0].orderId || relatedOrders[0].id || '';
                            const numericPart = firstOrderId.replace(/[^0-9]/g, '');
                            invoiceNumberPrefix = numericPart || '0001';
                        } else {
                            invoiceNumberPrefix = '0001';
                        }
                        const invoiceNumber = `${invoiceNumberPrefix}/${formattedDate}`;
                        
                        doc.text(`DATE : ${formatDate(invoiceDate)}`, 140, addressStartY);
                        doc.text(`INVOICE NO : ${invoiceNumber}`, 140, addressStartY + 6);
                        doc.text(`Orders Included: ${relatedOrders.length}`, 140, addressStartY + 12);
                        
                        // Items table
                        y += 15;
                        doc.setFontSize(10);
                        
                        // Table headers
                        const headers = ['S/N', 'DESCRIPTION', 'UOM', 'QTY', 'UNIT PRICE', 'AMOUNT'];
                        const colWidths = [15, 60, 25, 20, 25, 25];
                        let x = 20;
                        
                        // Draw header background
                        doc.setFillColor(240, 240, 240);
                        doc.rect(20, y - 5, 170, 8, 'F');
                        
                        headers.forEach((header, i) => {
                            doc.text(header, x, y);
                            x += colWidths[i];
                        });
                        
                        y += 8;
                        
                        // Table rows
                        const items = Object.values(combinedItems);
                        items.forEach((item, index) => {
                            x = 20;
                            
                            if (y > 250) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            const uomValue = item.UOM || item.unitChinese || '';
                            
                            // Convert Chinese characters to placeholder for now
                            let itemName = item.name || '';
                            if (/[\u4e00-\u9fff]/.test(itemName)) {
                                itemName = `[Chinese: ${itemName.length} chars]`;
                            }
                            
                            const rowData = [
                                (index + 1).toString(),
                                itemName,
                                uomValue,
                                (item.quantity || 0).toString(),
                                `${(item.price || 0).toFixed(2)}`,
                                `${(item.subtotal || 0).toFixed(2)}`
                            ];
                            
                            rowData.forEach((data, i) => {
                                const maxWidth = colWidths[i] - 2;
                                const text = i === 1 ? doc.splitTextToSize(data, maxWidth)[0] : data;
                                doc.text(text, x, y);
                                x += colWidths[i];
                            });
                            
                            y += 6;
                        });
                        
                        // Totals
                        y += 10;
                        const totalsX = 120;
                        
                        doc.text('TOTAL', totalsX, y);
                        doc.text(`${totalSubtotal.toFixed(2)}`, 170, y, { align: 'right' });
                        y += 6;
                        
                        doc.text('ADD GST@9%', totalsX, y);
                        doc.text(`${(totalSubtotal * 0.09).toFixed(2)}`, 170, y, { align: 'right' });
                        y += 6;
                        
                        doc.setFontSize(12);
                        doc.text('TOTAL DUE IN S$', totalsX, y);
                        doc.text(`${(totalSubtotal * 1.09).toFixed(2)}`, 170, y, { align: 'right' });
                        
                        // Signature section
                        y += 20;
                        doc.setFontSize(10);
                        
                        const leftColumnX = 20;
                        const rightColumnX = 105;
                        
                        doc.text('ISSUED BY :', leftColumnX, y);
                        doc.text('RECEIVED BY :', rightColumnX, y);
                        
                        y += 10;
                        doc.text('Issuer: _________________', leftColumnX, y);
                        doc.text('Receiver: _________________', rightColumnX, y);
                        
                        y += 12;
                        doc.text('Prepared by: _________________', leftColumnX, y);
                        
                        // Order references
                        y += 15;
                        doc.text('Order References:', 20, y);
                        y += 6;
                        
                        const orderRefs = relatedOrders.map(o => o.orderId).join(', ');
                        const refLines = doc.splitTextToSize(orderRefs, 160);
                        refLines.forEach(line => {
                            doc.text(line, 20, y);
                            y += 6;
                        });
                        
                        // Save PDF
                        doc.save(`Invoice_${order.outletId}_${formatDate(invoiceDate).replace(/\//g, '')}.pdf`);
                    } catch (error) {
                        alert('Failed to generate PDF: ' + error.message);
                    }
                };
                // Update order status
                const updateOrderStatus = async (order, newStatus) => {
                    updatingStatus.value = true;
                    
                    try {
                        const orderRef = doc(db, 'orders', order.id);
                        await updateDoc(orderRef, {
                            status: newStatus,
                            updatedAt: serverTimestamp()
                        });
                        
                        // Update local data
                        order.status = newStatus;
                        
                        // Show success message
                        alert(t('orderStatusUpdated'));
                    } catch (error) {
                        console.error('Error updating order status:', error);
                        alert(t('failedToUpdateStatus', error.message));
                    } finally {
                        updatingStatus.value = false;
                    }
                };
                
                // Toggle language
                const toggleLanguage = () => {
                    currentLang.value = currentLang.value === 'zh' ? 'en' : 'zh';
                    localStorage.setItem('preferred_language', currentLang.value);
                };
                
                // Initialize
                onMounted(() => {
                    // Check authentication
                    onAuthStateChanged(auth, (user) => {
                        checkAuthStatus(user);
                        
                        // Show app and hide loading screen
                        document.getElementById('app').classList.add('loaded');
                        document.getElementById('initial-loading').style.display = 'none';
                    });
                    
                    // Load saved language preference
                    const savedLang = localStorage.getItem('preferred_language');
                    if (savedLang && (savedLang === 'zh' || savedLang === 'en')) {
                        currentLang.value = savedLang;
                    }
                    
                    // Set default date range (last 30 days)
                    const today = new Date();
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    
                    endDate.value = today.toISOString().split('T')[0];
                    startDate.value = thirtyDaysAgo.toISOString().split('T')[0];
                });
                
                // Load orders when authenticated
                watch(isAuthenticated, async (isAuthed) => {
                    if (isAuthed) {
                        await loadOrders();
                    }
                });
                
                // Handle click outside modal
                window.onclick = (event) => {
                    const modal = document.getElementById('orderModal');
                    if (event.target === modal) {
                        closeModal();
                    }
                };
                
                return {
                    currentLang,
                    t,
                    toggleLanguage,
                    isAuthenticated,
                    isCheckingAuth,
                    userEmail,
                    goBack,
                    orders,
                    isLoading,
                    searchQuery,
                    outletFilter,
                    startDate,
                    endDate,
                    availableOutletPrefixes,
                    filteredOrders,
                    showModal,
                    selectedOrder,
                    formatDate,
                    formatDateTime,
                    getStatusClass,
                    getStatusText,
                    viewOrderDetails,
                    closeModal,
                    downloadPDF,
                    updateOrderStatus,
                    updatingStatus,
                    message
                };
            }
        }).mount('#app');
    </script>
</body>
</html>