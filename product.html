<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品管理系统 - SHIAWASE (S) PTE LTD</title>
    <link rel="stylesheet" href="product.css">
    <!-- Inline styles for product.html only -->
    <style>
      #app .search-container {
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      #app .search-container .search-input {
        width: 100%;
        margin-bottom: 0;
      }
      #app .search-container .import-btn {
        margin-left: 0;
        margin-top: 16px;
        align-self: flex-start;
      }
    </style>
    <!-- Vue 3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
</head>
<body>
    <!-- Initial loading screen -->
    <div id="initial-loading" class="app-loading">
        <div class="app-loading-spinner"></div>
        <div class="app-loading-text">Loading...</div>
    </div>

    <div id="app">
        <header>
            <div class="header-content">
                <div class="logo">
                    <img src="logo.png" alt="Logo"> SHIAWASE (S) PTE LTD
                </div>
                <div class="header-actions">
                    <div v-if="isAuthenticated" class="user-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                        {{ userEmail }}
                    </div>
                    <button class="back-btn" @click="goBack">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                        </svg>
                        {{ t('back') || 'Back' }}
                    </button>
                    <button class="language-toggle" @click="toggleLanguage">
                        {{ currentLang === 'zh' ? 'English' : '中文' }}
                    </button>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- Auth loading state -->
            <div v-if="isCheckingAuth" class="auth-loading">
                <div class="loading-spinner"></div>
                <p>{{ t('checkingAuth') || 'Checking authentication...' }}</p>
            </div>
            
            <!-- Content is visible only when authenticated -->
            <div v-else-if="isAuthenticated">
                <h1>{{ t('appTitle') }} <span class="english-subtext" v-if="currentLang === 'zh'">Product Management</span></h1>
                
                <!-- Message display -->
                <div v-if="message.text" :class="['message', message.type === 'success' ? 'message-success' : 'message-error']">
                    {{ message.text }}
                </div>
                
                <!-- Outlet selection with prefix filter -->
                <div class="card">
                    <div class="form-group">
                        <label for="outletPrefix">{{ t('selectOutletPrefix') }} <span class="english-subtext" v-if="currentLang === 'zh'">Outlet Code Prefix:</span></label>
                        <select id="outletPrefix" class="form-control" v-model="selectedPrefix">
                            <option value="">{{ t('selectPrefixPlaceholder') }}</option>
                            <option v-for="prefix in outletPrefixes" :key="prefix" :value="prefix">{{ prefix }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="outlet">{{ t('selectOutlet') }} <span class="english-subtext" v-if="currentLang === 'zh'">Select Outlet:</span></label>
                        <select 
                            id="outlet" 
                            class="form-control" 
                            v-model="selectedOutlet" 
                            :disabled="filteredOutletsByPrefix.length === 0 || isLoadingOutlets">
                            <option value="">{{ t('selectOutletPlaceholder') }}</option>
                            <option v-for="outlet in filteredOutletsByPrefix" :key="outlet.id" :value="outlet.id">
                                {{ outlet.name }}
                            </option>
                        </select>
                    </div>
                </div>
                
                <!-- Current Outlet Products -->
                <div v-if="selectedOutlet">
                    <h2>{{ t('currentOutletProducts') }} <span class="english-subtext" v-if="currentLang === 'zh'">Current Outlet Products</span></h2>
                    <div class="card">
                        <div class="search-container">
                            <input type="text" class="search-input" v-model="outletSearchQuery" :placeholder="t('searchOutletProducts')">
                            <button class="btn btn-secondary import-btn" @click="showImportModal = true" :disabled="!selectedOutlet">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                {{ t('importFromOutlet') }}
                            </button>
                        </div>
                        
                        <div v-if="isLoadingOutletProducts" class="loading">{{ t('loadingOutletProducts') }}</div>
                        
                        <div v-else-if="outletProducts.length === 0" class="empty-state">
                            {{ t('noOutletProductsFound') }}
                        </div>
                        
                        <table v-else class="product-table">
                            <thead>
                                <tr>
                                    <th style="width: 70px;">{{ t('image') }}</th>
                                    <th>{{ t('productName') }}</th>
                                    <th>{{ t('chineseName') }}</th>
                                    <th>{{ t('price') }}</th>
                                    <th>{{ t('unit') }}</th>
                                    <th>{{ t('uom') }}</th>
                                    <th>{{ t('actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="product in filteredOutletProducts" :key="product.id">
                                    <td>
                                        <img :src="product.imageData || product.image || '/logo.png'" :alt="product.name" class="table-image">
                                    </td>
                                    <td>{{ product.name }}</td>
                                    <td>{{ product.cname }}</td>
                                    <td>${{ product.price }}</td>
                                    <td>{{ currentLang === 'en' ? getUnitDisplay(product.unit) : product.unit }}</td>
                                    <td>{{ product.UOM }}</td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="btn btn-danger" @click="removeFromOutlet(product)">{{ t('remove') }}</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Available Products Section -->
                <h2>{{ t('availableProducts') }} <span class="english-subtext" v-if="currentLang === 'zh'">Available Products</span></h2>
                <div class="card">
                    <div class="search-container">
                        <input type="text" class="search-input" v-model="allProductsSearchQuery" :placeholder="t('searchAvailableProducts')">
                    </div>
                    
                    <div v-if="isLoadingAllProducts" class="loading">{{ t('loadingAvailableProducts') }}</div>
                    
                    <div v-else-if="filteredAllProducts.length === 0" class="empty-state">
                        {{ t('noAvailableProductsFound') }}
                    </div>
                    
                    <table v-else class="product-table">
                        <thead>
                            <tr>
                                <th style="width: 70px;">{{ t('image') }}</th>
                                <th>{{ t('productName') }}</th>
                                <th>{{ t('chineseName') }}</th>
                                <th>{{ t('price') }}</th>
                                <th>{{ t('unit') }}</th>
                                <th>{{ t('uom') }}</th>
                                <th>{{ t('actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="product in filteredAllProducts" :key="product.id">
                                <td>
                                    <img :src="product.imageData || product.image || '/logo.png'" :alt="product.name" class="table-image">
                                </td>
                                <td>{{ product.name }}</td>
                                <td>{{ product.cname }}</td>
                                <td>${{ product.price }}</td>
                                <td>{{ currentLang === 'en' ? getUnitDisplay(product.unit) : product.unit }}</td>
                                <td>{{ product.UOM }}</td>
                                <td>
                                    <div class="table-actions">
                                        <button 
                                            class="btn btn-primary" 
                                            @click="addToOutlet(product)"
                                            :disabled="!selectedOutlet">
                                            {{ t('addToOutlet') }}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Not authenticated message -->
            <div v-else class="auth-error">
                <h2>{{ t('notAuthorized') || 'Not Authorized' }}</h2>
                <p>{{ t('redirectingToLogin') || 'You are not authorized to access this page. Redirecting to home...' }}</p>
            </div>
        </div>
        
        <!-- Import Modal -->
        <div v-if="showImportModal" class="modal-overlay" @click="showImportModal = false">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>{{ t('importFromOutlet') }}</h3>
                    <button class="modal-close" @click="showImportModal = false">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="sourceOutlet">{{ t('selectSourceOutlet') }} <span class="english-subtext" v-if="currentLang === 'zh'">Select Source Outlet:</span></label>
                        <select id="sourceOutlet" class="form-control" v-model="selectedSourceOutlet" :disabled="isLoadingSourceOutletProducts">
                            <option value="">{{ t('selectSourceOutletPlaceholder') }}</option>
                            <option v-for="outlet in availableSourceOutlets" :key="outlet.id" :value="outlet.id">
                                {{ outlet.name }}
                            </option>
                        </select>
                    </div>
                    
                    <div v-if="selectedSourceOutlet && sourceOutletProducts.length > 0" class="source-products-preview">
                        <h4>{{ t('productsToImport') }} <span class="english-subtext" v-if="currentLang === 'zh'">Products to Import:</span></h4>
                        <div class="source-products-list">
                            <div v-for="product in productsToImport" :key="product.id" class="source-product-item">
                                <div class="source-product-name">{{ product.name }}</div>
                            </div>
                        </div>
                        <div class="import-summary">
                            <p>{{ t('importSummary', productsToImport.length, sourceOutletProducts.length) }}</p>
                        </div>
                    </div>
                    
                    <div v-else-if="selectedSourceOutlet && isLoadingSourceOutletProducts" class="loading-source">
                        <div class="loading-spinner"></div>
                        <p>{{ t('loadingSourceProducts') }}</p>
                    </div>
                    
                    <div v-else-if="selectedSourceOutlet && sourceOutletProducts.length === 0" class="empty-source">
                        {{ t('noProductsInSourceOutlet') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showImportModal = false">
                        {{ t('cancel') }}
                    </button>
                    <button 
                        class="btn btn-primary" 
                        @click="importProducts"
                        :disabled="!selectedSourceOutlet || productsToImport.length === 0 || isImporting">
                        <span v-if="isImporting">{{ t('importing') }}</span>
                        <span v-else>{{ t('importProducts') }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase v9 (modular) -->
    <script type="module">
        import { firebaseConfig } from './secrets.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { 
            getAuth,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Create Vue app
        const { createApp, ref, onMounted, computed, watch } = Vue;
        createApp({
            setup() {
                // Authentication states
                const isAuthenticated = ref(false);
                const isCheckingAuth = ref(true);
                const userEmail = ref('');
                
                // Check authentication - simplified version
                const checkAuthStatus = (user) => {
                    if (user) {
                        // User is signed in - we trust they're authorized
                        isAuthenticated.value = true;
                        userEmail.value = user.email;
                    } else {
                        // No user is signed in
                        isAuthenticated.value = false;
                        // Redirect to login page
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    }
                    isCheckingAuth.value = false;
                };
                
                // Back button function
                const goBack = () => {
                    window.location.href = 'index.html';
                };
                
                // Language settings
                const languages = {
                    zh: '中文',
                    en: 'English'
                };
                
                const currentLang = ref('zh'); // Default to Chinese
                
                // Translations
                const translations = {
                    appTitle: {
                        zh: '产品管理系统',
                        en: 'Product Management'
                    },
                    removeConfirm:{
                        zh:'确认产品移除',
                        en:'Confirm Product Removal'
                    },
                    selectOutlet: {
                        zh: '选择门店',
                        en: 'Select Outlet'
                    },
                    selectOutletPlaceholder: {
                        zh: '请选择门店',
                        en: 'Please select an outlet'
                    },
                    currentOutletProducts: {
                        zh: '当前门店产品',
                        en: 'Current Outlet Products'
                    },
                    allProducts: {
                        zh: '所有产品',
                        en: 'All Products'
                    },
                    availableProducts: {
                        zh: '可用产品',
                        en: 'Available Products'
                    },
                    searchOutletProducts: {
                        zh: '搜索门店产品...',
                        en: 'Search outlet products...'
                    },
                    searchAvailableProducts: {
                        zh: '搜索可用产品...',
                        en: 'Search available products...'
                    },
                    loadingOutletProducts: {
                        zh: '加载门店产品中...',
                        en: 'Loading outlet products...'
                    },
                    loadingAvailableProducts: {
                        zh: '加载可用产品中...',
                        en: 'Loading available products...'
                    },
                    noOutletProductsFound: {
                        zh: '此门店暂无产品。',
                        en: 'No products found in this outlet.'
                    },
                    noAvailableProductsFound: {
                        zh: '未找到可用产品。',
                        en: 'No products found.'
                    },
                    image: {
                        zh: '图片',
                        en: 'Image'
                    },
                    productName: {
                        zh: '产品名称',
                        en: 'Product Name'
                    },
                    chineseName: {
                        zh: '中文名称',
                        en: 'Chinese Name'
                    },
                    price: {
                        zh: '价格',
                        en: 'Price'
                    },
                    unit: {
                        zh: '单位',
                        en: 'Unit'
                    },
                    uom: {
                        zh: '计量单位',
                        en: 'UOM (Unit of Measurement)'
                    },
                    actions: {
                        zh: '操作',
                        en: 'Actions'
                    },
                    addToOutlet: {
                        zh: '添加到门店',
                        en: 'Add to Outlet'
                    },
                    remove: {
                        zh: '移除',
                        en: 'Remove'
                    },
                    alreadyAdded: {
                        zh: '已添加',
                        en: 'Already Added'
                    },
                    addSuccess: {
                        zh: '产品 "{0}" 已添加到门店。',
                        en: 'Product "{0}" has been added to the outlet.'
                    },
                    removeSuccess: {
                        zh: '产品 "{0}" 已从门店移除。',
                        en: 'Product "{0}" has been removed from the outlet.'
                    },
                    addError: {
                        zh: '添加产品失败: {0}',
                        en: 'Failed to add product: {0}'
                    },
                    removeError: {
                        zh: '移除产品失败: {0}',
                        en: 'Failed to remove product: {0}'
                    },
                    loadingOutlets: {
                        zh: '加载门店中...',
                        en: 'Loading outlets...'
                    },
                    noOutletsFound: {
                        zh: '未找到门店。',
                        en: 'No outlets found.'
                    },
                    outletLoadError: {
                        zh: '加载门店失败: {0}',
                        en: 'Failed to load outlets: {0}'
                    },
                    outletNotFound: {
                        zh: '门店未找到',
                        en: 'Outlet not found'
                    },
                    // Authentication translations
                    checkingAuth: {
                        zh: '验证身份中...',
                        en: 'Checking authentication...'
                    },
                    notAuthorized: {
                        zh: '未授权访问',
                        en: 'Not Authorized'
                    },
                    redirectingToLogin: {
                        zh: '您无权访问此页面。正在重定向到首页...',
                        en: 'You are not authorized to access this page. Redirecting to home...'
                    },
                    back: {
                        zh: '返回',
                        en: 'Back'
                    },
                    filterOutlets: {
                        zh: '过滤门店',
                        en: 'Filter outlets'
                    },
                    selectOutletPrefix: {
                        zh: '选择门店前缀',
                        en: 'Select Outlet Prefix'
                    },
                    selectPrefixPlaceholder: {
                        zh: '请选择前缀',
                        en: 'Please select a prefix'
                    },
                    importFromOutlet: {
                        zh: '从其他门店导入',
                        en: 'Import from Another Outlet'
                    },
                    selectSourceOutlet: {
                        zh: '选择源门店',
                        en: 'Select Source Outlet'
                    },
                    selectSourceOutletPlaceholder: {
                        zh: '请选择源门店',
                        en: 'Please select a source outlet'
                    },
                    productsToImport: {
                        zh: '要导入的产品',
                        en: 'Products to Import'
                    },
                    importSummary: {
                        zh: '将导入 {0} 个产品，其中 {1} 个可用',
                        en: 'Importing {0} products, {1} available'
                    },
                    cancel: {
                        zh: '取消',
                        en: 'Cancel'
                    },
                    importing: {
                        zh: '正在导入',
                        en: 'Importing'
                    },
                    importProducts: {
                        zh: '导入产品',
                        en: 'Import Products'
                    },
                    noProductsInSourceOutlet: {
                        zh: '源门店暂无产品',
                        en: 'No products found in the source outlet'
                    },
                    importSuccess: {
                        zh: '成功导入 {0} 个产品，跳过 {1} 个产品',
                        en: 'Successfully imported {0} products, skipped {1} products'
                    },
                    importFailed: {
                        zh: '导入失败，跳过 {0} 个产品',
                        en: 'Import failed, skipped {0} products'
                    },
                    importError: {
                        zh: '导入失败: {0}',
                        en: 'Import failed: {0}'
                    },
                    sourceOutletLoadError: {
                        zh: '加载源门店产品失败: {0}',
                        en: 'Failed to load source outlet products: {0}'
                    },
                    loadingSourceProducts: {
                        zh: '加载源门店产品中...',
                        en: 'Loading source outlet products...'
                    }
                };
                
                // Function to get translation
                const t = (key, ...args) => {
                    let text = translations[key]?.[currentLang.value] || key;
                    if (args.length > 0) {
                        args.forEach((arg, index) => {
                            text = text.replace(`{${index}}`, arg);
                        });
                    }
                    return text;
                };
                
                // Outlet data
                const outlets = ref([]);
                const isLoadingOutlets = ref(false);
                const outletMessage = ref({ type: '', text: '' });
                
                // Form data
                const selectedOutlet = ref('');
                const outletFilter = ref('');
                
                // UI states
                const message = ref({ type: '', text: '' });
                
                // Product data
                const outletProducts = ref([]);
                const allProducts = ref([]);
                const isLoadingOutletProducts = ref(false);
                const isLoadingAllProducts = ref(false);
                const outletSearchQuery = ref('');
                const allProductsSearchQuery = ref('');
                
                // Units options
                const unitOptions = ref([
                    '包 (PACK)', 
                    '盒 (BOX)', 
                    '桶 (TUB)', 
                    '件 (PC)', 
                    '瓶 (BOTTLE)', 
                    '箱 (CARTON)', 
                    '袋 (BAG)',
                    '条 (STRIP)'
                ]);
                
                // Add refs and computed
                const selectedPrefix = ref('');
                // Compute all unique prefixes
                const outletPrefixes = computed(() => {
                    const set = new Set();
                    outlets.value.forEach(outlet => {
                        const dashIdx = outlet.id.indexOf('-');
                        if (dashIdx > 0) set.add(outlet.id.substring(0, dashIdx));
                    });
                    return Array.from(set).sort();
                });
                // Filter outlets by selected prefix
                const filteredOutletsByPrefix = computed(() => {
                    if (!selectedPrefix.value) return [];
                    return outlets.value.filter(outlet => outlet.id.startsWith(selectedPrefix.value + '-'));
                });
                
                // Function to load outlets from Firestore
                const loadOutlets = async () => {
                    isLoadingOutlets.value = true;
                    outletMessage.value = { type: '', text: '' };
                    
                    try {
                        const outletsRef = collection(db, 'outlets');
                        const snapshot = await getDocs(outletsRef);
                        
                        if (snapshot.empty) {
                            outlets.value = [];
                            outletMessage.value = { type: 'error', text: t('noOutletsFound') };
                            return;
                        }
                        
                        outlets.value = snapshot.docs.map(doc => {
                            return {
                                id: doc.id,
                                name: doc.data().name || doc.id // Use data.name if available, otherwise use doc.id
                            };
                        });
                        
                        // Sort outlets by name for better UX
                        outlets.value.sort((a, b) => a.name.localeCompare(b.name));
                    } catch (error) {
                        console.error('Error loading outlets:', error);
                        outletMessage.value = { type: 'error', text: t('outletLoadError', error.message) };
                    } finally {
                        isLoadingOutlets.value = false;
                    }
                };
                
                // Function to extract Chinese part from unit format
                const extractChinesePart = (unit) => {
                    return unit.split(' ')[0];
                };
                
                // Function to extract English part from unit format
                const extractEnglishPart = (unit) => {
                    const match = unit.match(/\(([^)]+)\)/);
                    return match ? match[1] : unit;
                };
                
                // Function to get the appropriate unit display based on language
                const getUnitDisplay = (unit) => {
                    if (!unit) return '';
                    
                    // If the unit already contains both parts (Chinese + English in parentheses)
                    if (unit.includes('(') && unit.includes(')')) {
                        return currentLang.value === 'en' ? extractEnglishPart(unit) : unit;
                    }
                    
                    // If it's only the Chinese character (from database)
                    const matchingUnit = unitOptions.value.find(u => extractChinesePart(u) === unit);
                    if (matchingUnit) {
                        return currentLang.value === 'en' ? extractEnglishPart(matchingUnit) : unit;
                    }
                    
                    return unit;
                };
                
                // Load outlet products by resolving productId references to global products
                const loadOutletProducts = async () => {
                    if (!selectedOutlet.value) {
                        outletProducts.value = [];
                        return;
                    }
                    isLoadingOutletProducts.value = true;
                    try {
                        // Get all product reference docs in the outlet's products subcollection
                        const productsRef = collection(db, `outlets/${selectedOutlet.value}/products`);
                        const snapshot = await getDocs(productsRef);
                        if (snapshot.empty) {
                            outletProducts.value = [];
                            return;
                        }
                        // For each doc, fetch the global product by productId
                        const outletProductsList = [];
                        for (const docSnap of snapshot.docs) {
                            const refData = docSnap.data();
                            if (!refData.productId) continue;
                            const globalRef = doc(db, 'products', refData.productId);
                            const globalDoc = await getDoc(globalRef);
                            if (globalDoc.exists()) {
                                outletProductsList.push({
                                    id: globalDoc.id,
                                    ...globalDoc.data(),
                                    _outletDocId: docSnap.id // for removal
                                });
                            }
                        }
                        outletProducts.value = outletProductsList;
                    } catch (error) {
                        console.error('Error loading outlet products:', error);
                        message.value = { type: 'error', text: error.message };
                    } finally {
                        isLoadingOutletProducts.value = false;
                    }
                };
                
                // Load all products from global products collection
                const loadAllProducts = async () => {
                    isLoadingAllProducts.value = true;
                    
                    try {
                        // Load from global products collection (like inventory.html)
                        const productsRef = collection(db, 'products');
                        const snapshot = await getDocs(productsRef);
                        
                        if (snapshot.empty) {
                            allProducts.value = [];
                            return;
                        }
                        
                        allProducts.value = snapshot.docs.map(doc => {
                            return {
                                id: doc.id,
                                ...doc.data()
                            };
                        });
                        
                        // Sort by name
                        allProducts.value.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    } catch (error) {
                        console.error('Error loading all products:', error);
                        message.value = { type: 'error', text: error.message };
                    } finally {
                        isLoadingAllProducts.value = false;
                    }
                };
                
                // Check if product is already in the selected outlet
                const isProductInOutlet = (productId) => {
                    return outletProducts.value.some(product => product.id === productId);
                };
                
                // Add product to outlet (store only productId and addedAt)
                const addToOutlet = async (product) => {
                    if (!selectedOutlet.value) {
                        message.value = { type: 'error', text: t('selectOutletFirst') };
                        return;
                    }
                    
                    if (isProductInOutlet(product.id)) {
                        message.value = { type: 'error', text: t('productAlreadyInOutlet') };
                        return;
                    }
                    
                    message.value = { type: '', text: '' };
                    
                    try {
                        // Add product to the outlet's products subcollection (only productId and addedAt)
                        const productRef = doc(db, `outlets/${selectedOutlet.value}/products`, product.id);
                        await setDoc(productRef, {
                            productId: product.id,
                            addedAt: serverTimestamp()
                        });
                        
                        message.value = { type: 'success', text: t('addSuccess', product.name) };
                        await loadOutletProducts();
                    } catch (error) {
                        message.value = { type: 'error', text: t('addError', error.message) };
                    }
                };
                
                // Remove product from outlet using _outletDocId
                const removeFromOutlet = async (product) => {
                    if (!confirm(t('removeConfirm', product.name))) {
                        return;
                    }
                    message.value = { type: '', text: '' };
                    try {
                        // Remove product from the outlet's products subcollection using _outletDocId
                        const productRef = doc(db, `outlets/${selectedOutlet.value}/products`, product._outletDocId);
                        await deleteDoc(productRef);
                        message.value = { type: 'success', text: t('removeSuccess', product.name) };
                        await loadOutletProducts();
                    } catch (error) {
                        message.value = { type: 'error', text: t('removeError', error.message) };
                    }
                };
                
                // Filter outlet products
                const filteredOutletProducts = computed(() => {
                    if (!outletSearchQuery.value) {
                        return outletProducts.value;
                    }
                    
                    const query = outletSearchQuery.value.toLowerCase();
                    return outletProducts.value.filter(product => 
                        (product.name && product.name.toLowerCase().includes(query)) || 
                        (product.cname && product.cname.toLowerCase().includes(query)) ||
                        (product.id && product.id.toLowerCase().includes(query))
                    );
                });
                
                // Filter all products (exclude those already in the outlet)
                const filteredAllProducts = computed(() => {
                    let products = allProducts.value;
                    
                    // Filter out products that are already in the selected outlet
                    if (selectedOutlet.value && outletProducts.value.length > 0) {
                        const outletProductIds = outletProducts.value.map(p => p.id);
                        products = products.filter(product => !outletProductIds.includes(product.id));
                    }
                    
                    // Apply search filter
                    if (!allProductsSearchQuery.value) {
                        return products;
                    }
                    
                    const query = allProductsSearchQuery.value.toLowerCase();
                    return products.filter(product => 
                        (product.name && product.name.toLowerCase().includes(query)) || 
                        (product.cname && product.cname.toLowerCase().includes(query)) ||
                        (product.id && product.id.toLowerCase().includes(query))
                    );
                });
                
                // Initialize
                onMounted(() => {
                    // Check authentication first
                    onAuthStateChanged(auth, (user) => {
                        checkAuthStatus(user);
                        
                        // Show app and hide loading screen after auth check
                        document.getElementById('app').classList.add('loaded');
                        document.getElementById('initial-loading').style.display = 'none';
                    });
                    
                    // Load saved language preference
                    const savedLang = localStorage.getItem('preferred_language');
                    if (savedLang && (savedLang === 'zh' || savedLang === 'en')) {
                        currentLang.value = savedLang;
                    }
                });
                
                // Load outlets and all products once authentication is confirmed
                watch(isAuthenticated, async (isAuthed) => {
                    if (isAuthed) {
                        await loadOutlets();
                        await loadAllProducts();
                    }
                });
                
                // Watch for outlet changes
                watch(selectedOutlet, async () => {
                    if (selectedOutlet.value) {
                        await loadOutletProducts();
                    } else {
                        outletProducts.value = [];
                    }
                });
                
                // Handle language switching
                const toggleLanguage = () => {
                    currentLang.value = currentLang.value === 'zh' ? 'en' : 'zh';
                    // Save preference to localStorage
                    localStorage.setItem('preferred_language', currentLang.value);
                };
                
                // New state for import modal
                const showImportModal = ref(false);
                const selectedSourceOutlet = ref('');
                const sourceOutletProducts = ref([]);
                const isLoadingSourceOutletProducts = ref(false);
                const isImporting = ref(false);
                
                // Computed property for available source outlets (exclude current outlet)
                const availableSourceOutlets = computed(() => {
                    return outlets.value.filter(outlet => outlet.id !== selectedOutlet.value);
                });
                
                // Computed property for products to import (exclude already existing ones)
                const productsToImport = computed(() => {
                    if (!selectedSourceOutlet.value || sourceOutletProducts.value.length === 0) {
                        return [];
                    }
                    
                    const currentProductIds = outletProducts.value.map(p => p.id);
                    return sourceOutletProducts.value.filter(product => 
                        !currentProductIds.includes(product.id)
                    );
                });
                
                // Function to load source outlet products
                const loadSourceOutletProducts = async () => {
                    if (!selectedSourceOutlet.value) {
                        sourceOutletProducts.value = [];
                        return;
                    }
                    
                    isLoadingSourceOutletProducts.value = true;
                    try {
                        // Get all product reference docs in the source outlet's products subcollection
                        const productsRef = collection(db, `outlets/${selectedSourceOutlet.value}/products`);
                        const snapshot = await getDocs(productsRef);
                        
                        if (snapshot.empty) {
                            sourceOutletProducts.value = [];
                            return;
                        }
                        
                        // For each doc, fetch the global product by productId
                        const sourceProductsList = [];
                        for (const docSnap of snapshot.docs) {
                            const refData = docSnap.data();
                            if (!refData.productId) continue;
                            
                            const globalRef = doc(db, 'products', refData.productId);
                            const globalDoc = await getDoc(globalRef);
                            if (globalDoc.exists()) {
                                sourceProductsList.push({
                                    id: globalDoc.id,
                                    ...globalDoc.data()
                                });
                            }
                        }
                        sourceOutletProducts.value = sourceProductsList;
                    } catch (error) {
                        console.error('Error loading source outlet products:', error);
                        message.value = { type: 'error', text: t('sourceOutletLoadError', error.message) };
                    } finally {
                        isLoadingSourceOutletProducts.value = false;
                    }
                };
                
                // Function to import products from source outlet
                const importProducts = async () => {
                    if (!selectedSourceOutlet.value || productsToImport.value.length === 0) {
                        return;
                    }
                    
                    isImporting.value = true;
                    message.value = { type: '', text: '' };
                    
                    try {
                        let importedCount = 0;
                        let skippedCount = 0;
                        
                        for (const product of productsToImport.value) {
                            try {
                                // Add product to the current outlet's products subcollection
                                const productRef = doc(db, `outlets/${selectedOutlet.value}/products`, product.id);
                                await setDoc(productRef, {
                                    productId: product.id,
                                    addedAt: serverTimestamp()
                                });
                                importedCount++;
                            } catch (error) {
                                console.error(`Error importing product ${product.id}:`, error);
                                skippedCount++;
                            }
                        }
                        
                        // Show success message
                        if (importedCount > 0) {
                            message.value = { 
                                type: 'success', 
                                text: t('importSuccess', importedCount, skippedCount) 
                            };
                        } else {
                            message.value = { 
                                type: 'error', 
                                text: t('importFailed', skippedCount) 
                            };
                        }
                        
                        // Reload current outlet products
                        await loadOutletProducts();
                        
                        // Close modal
                        showImportModal.value = false;
                        selectedSourceOutlet.value = '';
                        sourceOutletProducts.value = [];
                        
                    } catch (error) {
                        console.error('Error during import:', error);
                        message.value = { type: 'error', text: t('importError', error.message) };
                    } finally {
                        isImporting.value = false;
                    }
                };
                
                // Watch for source outlet changes
                watch(selectedSourceOutlet, async () => {
                    if (selectedSourceOutlet.value) {
                        await loadSourceOutletProducts();
                    } else {
                        sourceOutletProducts.value = [];
                    }
                });
                
                return {
                    currentLang,
                    languages,
                    t,
                    toggleLanguage,
                    outlets,
                    isLoadingOutlets,
                    outletMessage,
                    selectedOutlet,
                    outletProducts,
                    allProducts,
                    isLoadingOutletProducts,
                    isLoadingAllProducts,
                    outletSearchQuery,
                    allProductsSearchQuery,
                    filteredOutletProducts,
                    filteredAllProducts,
                    getUnitDisplay,
                    isProductInOutlet,
                    addToOutlet,
                    removeFromOutlet,
                    isAuthenticated,
                    isCheckingAuth,
                    userEmail,
                    goBack,
                    message,
                    outletFilter,
                    filteredOutletsByPrefix,
                    selectedPrefix,
                    outletPrefixes,
                    showImportModal,
                    selectedSourceOutlet,
                    sourceOutletProducts,
                    isLoadingSourceOutletProducts,
                    isImporting,
                    availableSourceOutlets,
                    productsToImport,
                    loadSourceOutletProducts,
                    importProducts
                };
            }
        }).mount('#app');
    </script>
</body>
</html>